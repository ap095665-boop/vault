<!DOCTYPE html><html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Vault</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">

<style>
body{background:#000;color:#00ff88;font-family:monospace;margin:0;text-align:center}

/* cards */
.entryCard{
 background:#fff;
 margin:12px;
 padding:18px;
 border-radius:16px;
 display:flex;
 align-items:center;
 position:relative;
 color:#000;
 overflow:hidden;
 transition: transform .18s ease, box-shadow .18s ease;
}

/* TITLE scroll if long */
.entryTitle{
 flex:1;
 font-size:18px;
 white-space:nowrap;
 overflow-x:auto;
 overflow-y:hidden;
 scrollbar-width:none;
}
.entryTitle::-webkit-scrollbar{display:none}

/* prevent buttons shrink */
.openBtn{flex-shrink:0}
.deleteEdge{flex-shrink:0}

/* open button */
.openBtn{
 margin-right:60px;
 background:#111;
 color:#00ff88;
 padding:10px 16px;
 border-radius:10px;
 border:none;
 transition:.15s;
}
.openBtn:active{transform:scale(.95)}

/* delete */
.deleteEdge{
 position:absolute;
 right:12px;
 top:50%;
 transform:translateY(-50%);
 background:none;
 border:none;
 font-size:22px;
 color:#ff4d4d;
}

/* inputs */
input{
 width:90%;
 padding:12px;
 margin:6px;
 background:#fff;
 color:#000;
 border:none;
 border-radius:8px;
}

/* buttons */
button{
 padding:10px;
 margin:6px;
 border:none;
 border-radius:10px;
 background:#111;
 color:#00ff88;
}

/* popup */
.popup{
 position:fixed;
 top:0;
 left:0;
 right:0;
 bottom:0;
 background:#000;
 padding:20px;
 display:none;
 overflow:auto;
}

/* scan animation */
.entryCard::after{
 content:"";
 position:absolute;
 top:0;
 left:0;
 width:100%;
 height:100%;
 pointer-events:none;
 background:linear-gradient(120deg,transparent,rgba(0,255,136,0.25),rgba(0,200,255,0.25),rgba(255,0,150,0.25),transparent);
 transform:translateX(-120%);
}
.entryCard.scan::after{animation:scanMove 1.2s linear}
@keyframes scanMove{from{transform:translateX(-120%)}to{transform:translateX(120%)}}

/* typing */
.cyberText{
 display:inline-block;
 white-space:nowrap;
 overflow:hidden;
 border-right:2px solid #00ff88;
 animation:typing 1.2s steps(20,end), blink .8s infinite;
}
@keyframes typing{from{width:0}to{width:100%}}
@keyframes blink{50%{border-color:transparent}}

/* view text copy gesture */
.viewText{
 word-break:break-word;
 line-height:1.4;
 padding:6px;
 border-radius:10px;
}
.viewText:active{background:rgba(0,255,136,0.08)}
</style>
</head>

<body>

<div id="loginPopup" class="popup" style="display:block">
<h3>Enter PIN</h3>
<input id="pinInput" type="password" inputmode="numeric" maxlength="4">
</div>

<h2>Secure Vault</h2>

<input id="searchInput" placeholder="Search title..." style="display:none">
<div id="dataArea"></div>
<button id="addBtn" onclick="openAdd()" style="display:none">+ Add Entry</button>

<div id="addPopup" class="popup">
<h3>Add Entry</h3>
<div id="rows"></div>
<button onclick="addRow()">+ Add Row</button>
<button onclick="saveEntry()">Save</button>
<button onclick="closeAdd()">Cancel</button>
</div>

<div id="viewPopup" class="popup">
<h3>Entry</h3>
<div id="viewData"></div>
<button onclick="editEntry()">Edit</button>
<button onclick="closeView()">Close</button>
</div>

<script src="crypto-engine.js"></script>

<script>

let actionLock=false;
let editIndex=null;
let creatingPin=false;
let firstPin=null;

/* LOGIN */

document.getElementById("pinInput").addEventListener("input", async function(){
 const pin=this.value;
 if(pin.length<4) return;

 let salt=localStorage.getItem("vaultSalt");

 if(!salt){
  if(!creatingPin){ firstPin=pin; creatingPin=true; this.value=""; alert("Confirm PIN"); return;}
  if(pin===firstPin){ await createVault(pin); afterLogin(); }
  else alert("PIN mismatch");
  return;
 }

 let ok=await unlockVault(pin);
 if(ok) afterLogin();
});

function afterLogin(){
 loginPopup.style.display="none";
 addBtn.style.display="block";
 searchInput.style.display="block";
 loadEntries();
}

/* LOAD ENTRIES */

function loadEntries(){
 if(!vaultMemory || !vaultMemory.entries){ dataArea.innerHTML=""; return;}

 let html="";
 vaultMemory.entries.forEach((e,i)=>{
  let title=e.rows?.[0]?.value || "Untitled";
  html+=`
  <div class="entryCard">
    <div class="entryTitle"><span class="cyberText">${title}</span></div>
    <button class="openBtn" onclick="viewEntry(${i})">Open</button>
    <button class="deleteEdge" onclick="deleteEntry(${i})">❌</button>
  </div>`;
 });

 dataArea.innerHTML=html;
 startScanAnimation();
 disableTypingAfterLoad();
}

function startScanAnimation(){
 const cards=document.querySelectorAll(".entryCard");
 cards.forEach((card,index)=>{
  setTimeout(()=>{ card.classList.add("scan");
   setTimeout(()=>card.classList.remove("scan"),1200);
  }, index*250);
 });
}

function disableTypingAfterLoad(){
 setTimeout(()=>{
   document.querySelectorAll(".cyberText").forEach(el=>{
     el.style.borderRight="none";
     el.style.animation="none";
   });
 },1400);
}

/* SEARCH */

document.getElementById("searchInput").addEventListener("input", function(){
 const query=this.value.toLowerCase();
 const cards=document.querySelectorAll(".entryCard");
 cards.forEach(card=>{
   const titleElement=card.querySelector(".entryTitle");
   if(!titleElement) return;
   const titleText=titleElement.innerText.toLowerCase();
   card.style.display=titleText.includes(query)?"flex":"none";
 });
});

/* ADD ENTRY */

function openAdd(){ editIndex=null; rows.innerHTML=""; createDefaultRows(); addPopup.style.display="block";}
function createDefaultRows(){ addRow("Title"); addRow("Name"); addRow("Data"); addRow("Sub Data");}

function addRow(label="Extra", value=""){
 let row=document.createElement("div");
 row.innerHTML=`
  <input placeholder="Label" value="${label}">
  <input placeholder="Value" value="${value}">
  <button onclick="deleteRow(this)">❌</button>`;
 rows.appendChild(row);
}

function deleteRow(btn){ btn.parentElement.remove();}
function closeAdd(){ addPopup.style.display="none";}

/* SAVE */

async function saveEntry(){
 if(actionLock) return;
 actionLock=true;

 let entry={rows:[]};
 rows.querySelectorAll("div").forEach(r=>{
  let inputs=r.querySelectorAll("input");
  entry.rows.push({label:inputs[0].value,value:inputs[1].value});
 });

 if(editIndex!==null) vaultMemory.entries[editIndex]=entry;
 else vaultMemory.entries.push(entry);

 await saveVault();
 loadEntries();
 closeAdd();
 actionLock=false;
}

/* VIEW ENTRY — DOUBLE TAP COPY */

function viewEntry(i){
 let entry=vaultMemory.entries[i];
 let html="";
 entry.rows.forEach(r=>{
  html+=`
  <div class="entryCard">
   <div class="viewText" ondblclick="copyText('${r.value}')">
    <b>${r.label}:</b><br>${r.value}
   </div>
  </div>`;
 });
 viewData.innerHTML=html;
 viewPopup.style.display="block";
 editIndex=i;
}

function closeView(){ viewPopup.style.display="none";}
function editEntry(){ let entry=vaultMemory.entries[editIndex]; rows.innerHTML=""; entry.rows.forEach(r=>addRow(r.label,r.value)); viewPopup.style.display="none"; addPopup.style.display="block";}

/* DELETE */

async function deleteEntry(i){
 if(actionLock) return;
 if(!confirm("Delete permanently?")) return;
 actionLock=true;
 vaultMemory.entries.splice(i,1);
 await saveVault();
 loadEntries();
 actionLock=false;
}

/* COPY GESTURE */

function copyText(text){
 navigator.clipboard.writeText(text);

 const toast=document.createElement("div");
 toast.innerText="Copied";
 toast.style.position="fixed";
 toast.style.bottom="30px";
 toast.style.left="50%";
 toast.style.transform="translateX(-50%)";
 toast.style.background="#111";
 toast.style.color="#00ff88";
 toast.style.padding="10px 18px";
 toast.style.borderRadius="12px";
 toast.style.zIndex="9999";
 toast.style.boxShadow="0 0 12px rgba(0,255,136,0.3)";
 document.body.appendChild(toast);

 setTimeout(()=>toast.remove(),1200);
}

</script>

</body>
</html>
