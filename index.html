<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Secure Vault</title>

<style>
body{background:#000;color:#00ff88;font-family:monospace;margin:0;text-align:center}
.entryCard{background:#fff;color:#000;margin:12px;padding:14px;border-radius:12px}
input{width:90%;padding:12px;margin:6px;background:#fff;color:#000;border:none;border-radius:8px}
button{padding:10px;margin:6px;border:none;border-radius:10px;background:#111;color:#00ff88}
.popup{position:fixed;top:0;left:0;right:0;bottom:0;background:#000;padding:20px;display:none;overflow:auto}
</style>
</head>

<body>

<!-- LOGIN -->
<div id="loginPopup" class="popup" style="display:block">
<h3>Enter PIN</h3>
<input id="pinInput" type="password">
<button onclick="login()">Unlock</button>
</div>

<h2>Secure Vault</h2>
<div id="dataArea"></div>
<button onclick="openAdd()">+ Add Entry</button>

<!-- ADD / EDIT -->
<div id="addPopup" class="popup">
<h3 id="formTitle">Add Entry</h3>
<div id="rows"></div>
<button onclick="addRow()">+ Add Row</button>
<button onclick="saveEntry()">Save</button>
<button onclick="closeAdd()">Cancel</button>
</div>

<!-- VIEW POPUP -->
<div id="viewPopup" class="popup">
<h3>Entry</h3>
<div id="viewData"></div>
<button onclick="editEntry()">Edit</button>
<button onclick="closeView()">Close</button>
</div>

<script src="crypto-engine.js"></script>

<script>

let actionLock=false;
let editIndex=null;

/* LOGIN */
async function login(){
 const pin=pinInput.value;

 let salt=localStorage.getItem("vaultSalt");
 if(!salt){
  await createVault(pin);
  loginPopup.style.display="none";
  loadEntries();
  return;
 }

 let ok=await unlockVault(pin);
 if(ok){
  loginPopup.style.display="none";
  loadEntries();
 }else alert("Wrong PIN");
}

/* LOAD */
function loadEntries(){
 let html="";
 vaultMemory.entries.forEach((e,i)=>{
  let title=e.rows[0]?.value||"Untitled";
  html+=`
  <div class="entryCard">
    ${title}
    <button onclick="viewEntry(${i})">Open</button>
    <button onclick="deleteEntry(${i})">Delete</button>
  </div>`;
 });
 dataArea.innerHTML=html;
}

/* ADD ENTRY */
function openAdd(){
 editIndex=null;
 rows.innerHTML="";
 createDefaultRows();
 addPopup.style.display="block";
}

function createDefaultRows(){
 addRow("Title");
 addRow("Name");
 addRow("Data");
 addRow("Sub Data");
}

function addRow(label="Extra", value=""){

 let row=document.createElement("div");

 row.innerHTML=`
  <input placeholder="Label" value="${label}">
  <input placeholder="Value" value="${value}">
  <button onclick="deleteRow(this)">‚ùå</button>
 `;

 rows.appendChild(row);
}
 

function closeAdd(){ addPopup.style.display="none"; }

/* SAVE */
async function saveEntry(){
 if(actionLock) return;
 actionLock=true;

 let entry={rows:[]};
 rows.querySelectorAll("div").forEach(r=>{
  let inputs=r.querySelectorAll("input");
  entry.rows.push({label:inputs[0].value,value:inputs[1].value});
 });

 if(editIndex!==null){
  vaultMemory.entries[editIndex]=entry;
 }else{
  vaultMemory.entries.push(entry);
 }

 await saveVault();
 closeAdd();
 loadEntries();
 actionLock=false;
}
 function deleteRow(btn){
 btn.parentElement.remove();
}
 

/* VIEW */
function viewEntry(i){
 let entry=vaultMemory.entries[i];
 let html="";
 entry.rows.forEach(r=>{
  html+=`
   <div class="entryCard">
    ${r.label}: ${r.value}
    <button onclick="copyText('${r.value}')">Copy</button>
   </div>`;
 });
 viewData.innerHTML=html;
 viewPopup.style.display="block";
 editIndex=i;
}

function closeView(){ viewPopup.style.display="none"; }

/* EDIT */
function editEntry(){
 let entry=vaultMemory.entries[editIndex];
 rows.innerHTML="";
 entry.rows.forEach(r=>addRow(r.label,r.value));
 viewPopup.style.display="none";
 addPopup.style.display="block";
}

/* DELETE */
async function deleteEntry(i){
 if(actionLock) return;
 actionLock=true;
 vaultMemory.entries.splice(i,1);
 await saveVault();
 loadEntries();
 actionLock=false;
}

/* COPY */
function copyText(t){
 navigator.clipboard.writeText(t);
 alert("Copied");
}

</script>

</body>
</html>
